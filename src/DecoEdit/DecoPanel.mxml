<?xml version="1.0" encoding="utf-8"?>
<s:BorderContainer xmlns:fx="http://ns.adobe.com/mxml/2009" 
				   xmlns:s="library://ns.adobe.com/flex/spark" 
				   xmlns:mx="library://ns.adobe.com/flex/mx" width="1155" height="800" creationComplete="onCreation()">
	<fx:Declarations>
		<s:RadioButtonGroup id="radiogroup1"/>
		<!-- 将非可视元素（例如服务、值对象）放在此处 -->
	</fx:Declarations>
	<fx:Script>
		<![CDATA[
			import manager.EventManager;
			import manager.EventType;
			import manager.GameEvent;
			
			import mx.collections.ArrayCollection;
			import mx.collections.Sort;
			import mx.core.UIComponent;
			import mx.events.IndexChangedEvent;
			import mx.managers.PopUpManager;
			
			import spark.events.IndexChangeEvent;
			
			private var mFilteredLibrary:ArrayCollection;
			
			private var mTabDict:Object;
			private var mTabNames:Array;
			
			private var mLastAddedTab:String;
			private var mModifiedAndSavedFiles:Object;

			private function onCreation():void {
				this.mTabDict = new Object();
				this.mTabNames = new Array();
				this.mModifiedAndSavedFiles = new Object();
				this.mTabNavigator.addEventListener(IndexChangedEvent.CHANGE, onTabIndexChanged);

				this.setLibrary();
			}
			
			private function onTabIndexChanged(event:IndexChangedEvent):void {
				if (this.mLastAddedTab == this.mTabNames[event.newIndex]) {
					
				}
				else {
					return;
					var groups:Array = this.mTabDict[this.mTabNames[event.newIndex]].edit.getGroups();
					if (groups && groups.length > 0) {
						var modified:Boolean = false;
						for (var i:int = 0; i < groups.length; i++) {
							if (this.mModifiedAndSavedFiles[groups]) {
								modified = true;
								break;
							}
						}
						if (modified) {
							this.mTabDict[this.mTabNames[event.newIndex]].edit.update();
						}
					}
				}
				this.mLastAddedTab = null;
			}
			
			public function init(name:String, w:Number, h:Number):void {
				this.width = w;
				this.height = h;
			}
			
			private function setLibrary():void {
				var menu:ContextMenu = new ContextMenu;
				var item:ContextMenuItem = new ContextMenuItem("重命名");
				item.addEventListener(ContextMenuEvent.MENU_ITEM_SELECT, onLibraryItemRename);
				menu.addItem(item);
				var item0:ContextMenuItem = new ContextMenuItem("删除");
				item0.addEventListener(ContextMenuEvent.MENU_ITEM_SELECT, onLibraryItemDelete);
				menu.addItem(item0);;
				this.mLibrary.contextMenu = menu;
				
				this.filterLibrary();
			} 
			
			private function onLibraryItemRename(event:Event):void {
				
			}
			
			private function onLibraryItemDelete(event:Event):void {
				
			}
			
			private function filterLibrary(event:Event=null):void {
				var content:String = this.mSearch.text;
				var searchContent:RegExp = new RegExp(content, "i");
				this.mFilteredLibrary = new ArrayCollection();
				for (var b:String in Data.getInstance().decoSet)
					if(b.search(searchContent) >= 0)
						this.mFilteredLibrary.addItem(b);
				this.mFilteredLibrary.sort = new Sort();
				this.mFilteredLibrary.refresh();
				
				this.mLibrary.dataProvider = this.mFilteredLibrary;
			}
			
			private function onPressClose(event:Event):void {
				PopUpManager.removePopUp(this);
				EventManager.getInstance().dispatchEvent(new GameEvent(EventType.DECO_PANEL_CLOSE));
			}
			
			private function onPressSave(event:Event):void {
				
			}
			
			private function onPressSaveAll(event:Event):void {
				
			}
			
			private function onPressPreview(event:Event):void {
				
			}
			
			private function onSearchChanged(event:Event):void {
				
			}

			private function onLibrarySelected(e:IndexChangeEvent):void {
				
			}
			
			private function onPressNewTab(event:Event):void {
//				for (var name:String in Data.getInstance().behaviorSet) {
//					if (name.indexOf("新行为") === 0) {
//						var str:String = name.substr(3);
//						var num:int = int(str);
//						if (num >= this.mTabSerial) {
//							this.mTabSerial = num+1;
//						}
//					}
//				}
//				addTab("新行为"+this.mTabSerial, [{type:"执行", children:[], data:null}]);
//				this.mTabSerial++;
			}
			
			private function addTab(name:String, data:Object, type:int):void {
				var tab:NavigatorContent;
				if (this.mTabDict[name]) {
					tab = this.mTabDict[name].tab;
					tab.removeAllElements();
				}
				else {
					tab = new NavigatorContent();
					this.mTabNavigator.addElement(tab);
					this.mTabNames.push(name);
				}
				
				var edit:Object;
				var modified:Object;
				if (type == 1) {
					edit = new DecoLayerEdit();
					modified = Data.getInstance().decoSet[name]==null?true:false;
				}
				else {
					edit = new DecoCellEdit();
					modified = Data.getInstance().decoGroupSet[name]==null?true:false;
				}
				tab.addElement(edit as UIComponent);
				
				tab.label = name+(modified?"*":"");
				var index:int = this.mTabNames.indexOf(name);
				this.mTabNavigator.selectedIndex = index;
				this.mLastAddedTab = name;
				
				this.mTabDict[name] = {tab:tab, modified:modified, edit:edit, type:type};
			}
			
			private function closeTab(name:String):void {
				if (this.mTabDict[name]) {
					this.mTabNavigator.removeChild(this.mTabDict[name].tab);
					this.mTabNames.splice(this.mTabNames.indexOf(name), 1);
					delete this.mTabDict[name];
				}
			}
			
			private function renameTab(from:String, to:String):void {
				if (this.mTabDict[from]) {
					var index:int = this.mTabNames.indexOf(from);
					this.mTabNames[index] = to;
					var info:Object = this.mTabDict[from];
					this.mTabDict[to] = info;
					info.tab.label = to+(info.modified?"*":"");
					info.edit.rename(to);
					this.mTabDict[from] = null;
					delete this.mTabDict[from];
				}
			}
			
			private function switchToTab(name:String):void {
				var index:int = this.mTabNames.indexOf(name);
				if (index >= 0) {
					this.mTabNavigator.selectedIndex = index;
				}
				else {
					this.addTab(name, {}, 1);
				}
			}
			
			public function setTabModified(name:String, modified:Boolean):void {
				if (this.mTabDict[name]) {
					this.mTabDict[name].modified = true;
					this.mTabDict[name].tab.label = name+(modified?"*":"");
				}
			}
			
		]]>
	</fx:Script>
	
	<s:Button right="0" top="0" width="30" height="20" label="x" click="onPressClose(event)"/>
	<s:HGroup right="155" top="10" horizontalAlign="left">
		<s:RadioButton label="装饰库" groupName="radiogroup1"
					   selected="true"/>
		<s:RadioButton label="组合库" groupName="radiogroup1"/>
	</s:HGroup>
	<s:HGroup x="0" y="0" width="100%" height="30">
		<s:Button width="80" height="25" label="保存当前" click="onPressSave(event)"/>
		<s:Button width="80" height="25" label="保存所有" click="onPressSaveAll(event)"/>
		<s:Button width="80" height="25" label="预览效果" click="onPressPreview(event)"/>
	</s:HGroup>
	<s:HGroup left="0" top="30" width="100%" height="100%" gap="5">
		<s:Panel width="150" height="100%" borderVisible="false" dropShadowVisible="false"
				 title="装饰">
			<s:HGroup x="0" y="0" width="100%" height="100%" gap="0">
				<s:VGroup width="100%" height="100%" gap="0">
					<s:TextInput id="mSearch" width="100%" change="onSearchChanged(event)"/>
					<s:List id="mLibrary" width="100%" height="100%" change="onLibrarySelected(event)"></s:List>
				</s:VGroup>
			</s:HGroup>
		</s:Panel>
		<s:Group width="100%" height="100%">
			<mx:TabNavigator id="mTabNavigator" width="100%" height="100%" paddingTop="0">
			</mx:TabNavigator>
			<s:Button right="0" top="0" width="30" label="+" click="onPressNewTab(event)"/>
		</s:Group>
		<s:Group width="150" height="100%">
			<mx:TabNavigator x="0" y="0" width="100%" height="100%" paddingTop="0">
				<s:NavigatorContent width="100%" height="100%" label="装饰元素">
					<s:VGroup id="mCellSelector" x="0" y="0" width="100%" height="100%">
					</s:VGroup>
				</s:NavigatorContent>
				<s:NavigatorContent width="100%" height="100%" label="装饰组合">
					<s:VGroup id="mGroupSelector" x="0" y="0" width="100%" height="100%">
					</s:VGroup>
				</s:NavigatorContent>
			</mx:TabNavigator>
			
		</s:Group>
	</s:HGroup>
</s:BorderContainer>
